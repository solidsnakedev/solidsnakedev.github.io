---
import TerminalLayout from '../../layouts/TerminalLayout.astro';
import { 
  Table, 
  TableRow, 
  Card, 
  StatusBar, 
  CursorBlock,
  Section
} from '../../components/terminal';
import { getCollection } from 'astro:content';

const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Format date VMS style
function formatVMSDate(date: Date) {
  const day = date.getDate().toString().padStart(2, '0');
  const months = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  const month = months[date.getMonth()];
  const year = date.getFullYear();
  return `${day}-${month}-${year}`;
}

const tableHeaders = [
  { label: 'IDX', span: 1 },
  { label: 'DATE', span: 2 },
  { label: 'TITLE', span: 5 },
  { label: 'TAGS', span: 2 },
  { label: 'STATUS', span: 2 }
];

const uniqueTags = [...new Set(posts.flatMap(p => p.data.tags || []))];
---

<TerminalLayout title="BLOG_ARCHIVE" section="blog">
  <!-- Post Listing Table -->
  <Table title="BLOG ENTRIES" headers={tableHeaders} class="mb-4">
    {posts.map((post, index) => (
      <TableRow href={`/blog/${post.slug}`}>
        <span class="col-span-1 text-amber-500/50">{String(index + 1).padStart(3, '0')}</span>
        <span class="col-span-2 text-cyan-400">{formatVMSDate(post.data.pubDate)}</span>
        <span class="col-span-5 text-white truncate">{post.data.title}</span>
        <span class="col-span-2 text-purple-400 truncate">
          {post.data.tags?.slice(0, 2).join(', ') || '-'}
        </span>
        <span class="col-span-2 text-green-400">PUBLISHED</span>
      </TableRow>
    ))}
  </Table>

  <!-- Detailed Post Cards -->
  <div class="space-y-3 flex-1">
    {posts.map((post, index) => (
      <Card 
        title={post.data.title}
        status="PUBLISHED"
        statusColor="text-green-400"
        footerRight={`idx:${String(index).padStart(3, '0')}`}
      >
        <!-- Date Badge -->
        <div class="text-xs text-cyan-400 mb-2">
          [{formatVMSDate(post.data.pubDate)}]
        </div>
        
        <!-- Description -->
        <div class="text-xs text-white/70 mb-3 border-l border-amber-500/30 pl-2">
          <span class="text-amber-500/50"># </span>{post.data.description}
        </div>
        
        <!-- Tags and Actions Row -->
        <div class="flex items-center justify-between flex-wrap gap-2">
          <!-- Tags -->
          <div class="flex gap-2 flex-wrap">
            {post.data.tags?.map((tag) => (
              <span class="px-2 py-0.5 border border-amber-500/30 text-xs text-purple-400 font-mono">
                #{tag}
              </span>
            ))}
          </div>
          
          <!-- Action Button -->
          <a 
            href={`/blog/${post.slug}`}
            class="px-2 py-1 border border-amber-500 text-amber-500 hover:bg-amber-500 hover:text-black transition-all text-xs font-mono"
          >
            [READ_MORE]
          </a>
        </div>
      </Card>
    ))}
  </div>

  {posts.length === 0 && (
    <Section variant="error" title="ERROR" class="mt-4">
      <div class="p-4 text-center">
        <div class="text-xs text-red-400 mb-2">No blog entries found in archive</div>
        <div class="text-xs text-white/50">Run `touch ~/blog/new_post.md` to create one</div>
      </div>
    </Section>
  )}

  <!-- Command Prompt -->
  <CursorBlock class="mt-4" />

  <!-- Status Bar -->
  <StatusBar 
    items={[
      { label: 'ENTRIES', value: posts.length.toString() },
      { label: 'TAGS', value: uniqueTags.length.toString() },
      { label: 'ARCHIVE', value: 'ACTIVE' }
    ]}
    status="SYSTEM READY"
  />
</TerminalLayout>
